# 403 排查与修复说明（Go 网关 vs Python 旧版）

## 结论（根因）
- 根因：Go 网关转发时没有处理 `User-Agent`，Go 的 `http.Client` 自动加了 `Go-http-client/2.0`，触发 Warp AI 侧 WAF/风控，导致 `/ai/multi-agent` 403。
- 修复：对 `/ai/*` 请求清空 `User-Agent`（或设置为 Warp 客户端 UA），避免 Go 默认 UA。
- 结果：修复后日志显示 `/ai/multi-agent` 200。

## 旧版（Python / mitmproxy）逻辑
- 透传客户端请求，保留原始 Header（不注入 Go 默认 UA）。
- 仅替换已有的 `Authorization / X-API-Key / x-api-key`。
- `experimentId` 为空时删除 `x-warp-experiment-id`。
- 账号池：限额/封禁触发自动切换，重置机器码，并写入 Warp 凭证文件。

## Go 网关逻辑（当前）
- 使用 go-mitmproxy 拦截 -> 转发上游。
- 注入账号：替换 `Authorization` 为 `Bearer wk-...`，同步 `x-api-key`。
- 修改配额显示，规则注入。
- 切换账号时写入 Warp 凭证（Windows 使用 DPAPI）。
- 兼容国内网络：`securetoken.googleapis.com/v1/token` 重写到 `app.warp.dev/proxy/token`。

## 403 发生点（事实）
- GraphQL 请求均 200，只有 `/ai/multi-agent` 403。
- 403 内容是 HTML Forbidden（非业务 JSON）。
- 请求头里的 `Authorization` 已是 `wk-`，说明账号注入是正确的。

## 根因分析（为什么会 403）
- Go 的 `http.Client` 会在 `User-Agent` 缺省时自动添加 `Go-http-client/2.0`。
- Warp 的 AI 接口对 UA/指纹敏感，检测到非 Warp 客户端 UA 会直接 403。
- Python/mitmproxy 不会自动加 UA，因此不会触发这一层风控。
- 修复后立即 200，证明问题不在 token/experimentId，而在 UA。

## 修复方式（正确做法）
- 对 `/ai/*` 请求 **清空 User-Agent**，避免 Go 默认 UA。
- 或者显式设置为 Warp 客户端 UA（更接近真实客户端）。
- 继续保留旧版的行为：只替换已有的 auth 字段、空 experimentId 删除 header。

## 错误用法 / 错误实现（需要避免）
1. **错误实现**：不处理 UA，导致 Go 默认 `Go-http-client/2.0` → 403。
2. **错误用法**：把 refresh_token / id_token 直接当作 `Authorization`（AI 接口必须是 `wk-`）。
3. **错误实现**：切换账号后不写入 Warp 凭证，导致 Warp 客户端上下文仍是旧账号。
4. **错误用法**：网络无法访问 `securetoken.googleapis.com` 还强制走该域名（应走 `app.warp.dev/proxy/token`）。

## 账号池切换流程图
```mermaid
flowchart TD
  A[启动/请求进入] --> B[拦截请求 (go-mitmproxy)]
  B --> C[替换 Authorization / X-API-Key]
  C --> D{是否 /ai/multi-agent?}
  D -->|是| E[清空 User-Agent]
  D -->|否| F[继续]
  E --> G[转发上游]
  F --> G
  G --> H{响应}
  H -->|GetRequestLimitInfo| I[同步额度 + 判断是否用尽]
  I -->|用尽| J[标记 limited + 重置机器码 + 切换账号 + 写入凭证]
  I -->|未用尽| K[保持账号]
  H -->|AI 403 且匹配封禁| L[标记 banned + 重置机器码 + 切换账号 + 写入凭证 + 重试]
  H -->|AI 200| M[对话成功]
  B --> N{账号文件变化?}
  N -->|是| O[重载账号 + 写入凭证]
```

## 关键函数清单（Go 版）
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\gateway_addon.go`：请求/响应拦截、注入账号、AI UA 处理、重试逻辑。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\gateway_accounts.go`：账号池加载、可用账号选择、封禁/限额切换。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\warp_control.go`：写入 Warp 凭证、重置机器码、token 处理。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\warp_transport.go`：uTLS 指纹与上游连接。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\gateway_service.go`：代理启动与账号切换回调。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\mitm_interceptor.go`：TLS MITM 拦截入口。
- `C:\Users\Administrator\Desktop\2.0.0\go-gateway\config.go`：数据/日志路径与默认配置。

## 关键函数清单（Python 旧版）
- `C:\Users\Administrator\Desktop\2.0.0\backend\gateway\warp_gateway_pro.py`：账号注入、规则注入、配额同步、封禁切换。
- `C:\Users\Administrator\Desktop\2.0.0\backend\manager\warp_manager.py`：账号池管理、切换逻辑。

## 验证方法（日志判断）
查看：
`C:\Users\Administrator\Desktop\2.0.0\go-gateway\dist\single\data\logs\go-gateway.log`

必须出现：
- `user-agent cleared for ai request`
- `ai response: status=200`

这两行同时出现即代表 403 已解决。
