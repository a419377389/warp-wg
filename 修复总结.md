# 修复总结 - 账号状态同步 & MCP 自动安装

## 📋 修复的问题

### 问题 1：账号状态同步问题
**现象：** 前端切换账号后，被切换掉的账号（额度用完）在后台数据库中的状态没有及时更新。

**根源：** 
- 前端在 `SyncUsage` 触发切换时，调用的 `syncCurrentUsageToRemote()` 同步的是**新账号**的信息
- **旧账号**（被切换掉的账号）的状态没有同步到后端
- 后端无法触发二次检测，导致数据不准确

### 问题 2：MCP 自动安装问题
**现象：** 网关启动后，MCP 配置已写入 SQLite，但 Warp 客户端没有自动识别为"已安装"状态，需要手动点击安装。

**根源：**
- MCP 恢复时，`restore_running` 字段只是从备份中恢复原值
- 没有强制设置为 `1`（true），导致 Warp 客户端不会自动触发安装流程

---

## ✅ 修复内容

### 修复 1：前端账号状态同步（gateway_addon.go）

**文件：** `gateway_addon.go` (第 1299-1330 行)

**修改内容：**
```go
// 在切换前保存旧账号信息，用于同步到后端
oldAccount := w.accounts.Current()
virtualUsed, virtualQuota, needSwitch := w.accounts.SyncUsage(realUsed, realQuota)

// 账号额度用完时，同步旧账号状态到后台（触发后端二次检测）
if needSwitch && oldAccount != nil && oldAccount.ID > 0 {
    w.syncAccountStatusToRemote(oldAccount.ID, "limited", oldAccount.Quota, oldAccount.Quota)
}
```

**效果：**
- ✅ 切换账号时，同步**旧账号**的状态到后端
- ✅ 后端收到请求后，触发异步二次检测
- ✅ 3-5 秒后，后端数据库中的账号状态自动更新

---

### 修复 2：后端异步延迟检测（remote-backend/main.go）

**文件：** `remote-backend/main.go` (第 1291-1324 行)

**修改内容：**
```go
// 5. 更新 last_used_at，标记账号最近被使用
_, _ = a.db.ExecContext(...)

// 6. 异步延迟检测：延迟 3 秒后再调用 WARP API 检测账号状态
//    这样可以避免账号刚切换时 WARP API 数据还未更新的问题
go func() {
    time.Sleep(3 * time.Second)
    
    ctx := context.Background()
    _, err := a.applyAccountCheck(...)
    if err != nil {
        log.Printf("async account check failed for account %d (%s): %v", accountID, email, err)
    } else {
        log.Printf("async account check completed for account %d (%s)", accountID, email)
    }
}()

// 7. 立即返回成功，不等待检测完成
writeJSON(w, http.StatusOK, map[string]any{"success": true})
```

**效果：**
- ✅ 前端调用更新接口后立即返回，不阻塞
- ✅ 后端延迟 3 秒后异步检测账号状态
- ✅ 检测结果自动更新到数据库
- ✅ 完整的日志记录，方便调试

---

### 修复 3：MCP 自动安装（mcp_control.go）

**文件：** `mcp_control.go` (第 323-335 行)

**修改内容：**
```go
// Restore mcp_server_installations
for _, row := range backup.MCPServerInstallations {
    // 强制设置 restore_running = 1，触发 Warp 客户端自动安装 MCP 服务器
    // 这样 Warp 会识别这些 MCP 为"需要恢复运行"状态，自动完成安装流程
    restoreRunning := 1
    _, err = tx.Exec(
        "INSERT INTO mcp_server_installations (...) VALUES (?, ?, ?, ?, ?, ?)",
        row.ID, row.TemplatableMCPServer, row.TemplateVersionTS, 
        row.VariableValues, restoreRunning, row.LastModifiedAt,
    )
    ...
}
```

**效果：**
- ✅ MCP 配置恢复后，`restore_running` 字段强制设置为 `1`
- ✅ Warp 客户端自动识别为"需要恢复运行"状态
- ✅ 自动触发安装流程，无需手动点击安装
- ✅ 切换账号后，MCP 配置自动生效

---

## 🚀 编译和部署

### 1. 编译前端

```powershell
cd d:\项目\warp-wg
go build -o warp.exe
```

### 2. 编译后端

```powershell
cd d:\项目\warp-wg\remote-backend
go build -o remote-backend.exe
```

### 3. 停止旧服务

```powershell
# 停止前端网关
taskkill /F /IM warp.exe

# 停止后端服务
taskkill /F /IM remote-backend.exe
```

### 4. 启动新服务

```powershell
# 启动后端
cd d:\项目\warp-wg\remote-backend
.\remote-backend.exe

# 启动前端（新窗口）
cd d:\项目\warp-wg
.\warp.exe
```

---

## 🧪 测试验证

### 测试 1：账号状态同步

1. 启动前端网关和后端服务
2. 使用账号直到额度用完，触发自动切换
3. 查看前端日志，应该看到：
   ```
   [INFO] sync account status to remote: id=123 status=limited
   ```
4. 查看后端日志，应该看到（3-5秒后）：
   ```
   async account check completed for account 123 (user@example.com)
   ```
5. 刷新后台管理界面，被切换的账号状态应该更新为 `limited`

### 测试 2：MCP 自动安装

1. 在 Warp 客户端中手动安装一个 MCP 服务器（例如 filesystem）
2. 启动网关，触发账号切换
3. 查看前端日志，应该看到：
   ```
   [INFO] [MCP] backing up global MCP config
   [INFO] [MCP] restoring global MCP config
   ```
4. 打开 Warp 客户端，MCP 服务器应该自动显示为"已安装"状态
5. 无需手动点击安装，MCP 配置自动生效

---

## 📊 修改文件清单

| 文件 | 修改行数 | 修改内容 |
|------|---------|---------|
| `gateway_addon.go` | 1299-1330 | 切换账号时同步旧账号状态 |
| `remote-backend/main.go` | 1291-1324 | 异步延迟检测账号状态 |
| `mcp_control.go` | 323-335 | 强制设置 restore_running = 1 |

---

## 🎯 预期效果

### 账号状态同步
- ✅ 账号切换后，旧账号状态在 3-5 秒内自动更新
- ✅ 后台管理界面显示准确的账号状态
- ✅ 前端和后端日志完整记录同步过程

### MCP 自动安装
- ✅ 切换账号后，MCP 配置自动恢复
- ✅ Warp 客户端自动识别为"已安装"状态
- ✅ 无需手动点击安装，配置立即生效

---

## 📝 注意事项

1. **编译前备份**：建议先备份当前的 `warp.exe` 和 `remote-backend.exe`
2. **停止服务**：编译前确保停止所有运行中的服务
3. **测试环境**：建议先在测试环境验证，确认无误后再部署到生产环境
4. **日志监控**：部署后密切关注日志，确认修复生效

---

## 🔧 故障排查

### 如果账号状态仍未更新

1. 检查前端日志，确认是否有 `sync account status to remote` 日志
2. 检查后端日志，确认是否有 `async account check completed` 日志
3. 检查网络连接，确认前端能访问后端 API
4. 检查后端能访问 WARP API（https://app.warp.dev）

### 如果 MCP 仍需手动安装

1. 检查 Warp SQLite 数据库路径是否正确
2. 检查 `mcp_server_installations` 表中的 `restore_running` 字段是否为 1
3. 检查 `generic_string_objects` 表中的 `mcp_allowlist` 是否包含 MCP UUID
4. 重启 Warp 客户端，让其重新读取数据库

---

✅ **修复完成！** 现在可以开始编译和测试了。

